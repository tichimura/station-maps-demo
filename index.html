<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapbox Maps for your City</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
<link href="https://assets.website-files.com/5f291534dceb6cd8f0e7a02f/6019601de8e906e629493c4b_mapbox_favicon_32x32.png" rel="shortcut icon" type="image/x-icon"/>	
<style type="text/css">
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }

.mapboxgl-popup {
      padding-bottom: 5px;
    }

    .mapboxgl-popup-close-button {
      display: true;
    }

    .mapboxgl-popup-content {
      font: 400 15px/22px 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
      width: 250px;
    }

    .mapboxgl-popup-content-wrapper {
      padding: 1%;
    }

    .mapboxgl-popup-content h3 {
      background: rgb(61, 59, 59);
      text-align: center;
      color: #fff;
      margin: 0;
      display: block;
      padding: 15px;
      font-weight: 700;
      margin-top: -5px;
    }

    .mapboxgl-popup-content h4 {
      margin: 0;
      display: block;
      padding: 10px 3px 10px 10px;
      font-weight: 400;
    }

    .mapboxgl-popup-content img{
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 50%;
    }

    .mapboxgl-container {
      cursor: pointer;
    }

    .mapboxgl-popup-anchor-top>.mapboxgl-popup-content {
      margin-top: 3px;
    }

    .mapboxgl-popup-anchor-top>.mapboxgl-popup-tip {
      border-bottom-color: rgb(61, 59, 59);
    }



</style>
</head>

<body>

<div id="map"></div>


<script>


	mapboxgl.accessToken = 'pk.eyJ1IjoidGljaGltdXJhIiwiYSI6ImNrbWJhamE3ZDF6b2kyb210YWxpN3YyM3gifQ.VpB0MzutVQziz2fybIR0HA';

    var map = new mapboxgl.Map({
        container: 'map',
        zoom: 15,
        center: [139.73070222009164,35.689708324156825],
        bearing: -150,
        pitch: 60,
        style: 'mapbox://styles/tichimura/ckmnn5wu41cdz17qb95l492oy/draft',
        customAttribution: '<a href="http://www.douro-kouji-meter.ktr.mlit.go.jp/index.php" target="_blank">国土交通省　関東地方整備局</a> '
        
    });

    
    map.on('load', function () {
        // Add a GeoJSON source containing place coordinates and information.


        map.addSource('shibuya', {
                'type': 'image',
                'url': 'https://tichimura.github.io/station-maps-demo/resource/shibuya.png',
                // 'url': 'https://user-images.githubusercontent.com/1793451/112234285-8846ab00-8c7f-11eb-9c4c-b2d01344e4a3.png',          
                "coordinates": [
                    [
                      139.70240076659059,
                      35.65723961173801
                    ],
                    [
                      139.7011374768549,
                      35.65969202092519
                    ],                  
                    [
                      139.702563200059,
                      35.66020285545352
                    ],
                    [
                      139.70383613459353,
                      35.657753872675116
                    ],
                ]
        });

        map.addLayer({
          'id': 'gifLayer1',
          'type': 'raster',
          // Use "iso" as the data source for this layer
          'source': 'shibuya',
          'paint': { 'raster-opacity': 0.85 }
        },'transit-label');   
      
      
       map.addSource('iidabashi', {
                'type': 'image',
                'url': 'https://tichimura.github.io/station-maps-demo/resource/iidabashi.png',                
                // 'url': 'https://user-images.githubusercontent.com/1793451/112235353-ce9d0980-8c81-11eb-8e5e-3ab06ce7602c.png',          
                "coordinates": [
                      [
                        139.74121835308614,
                        35.69999177865097
                      ],
                      [
                        139.74532491602395,
                        35.704151331565924
                      ],
                      [
                        139.747358624943,
                        35.702833097024495
                      ],
                      [
                        139.74320330512847,
                        35.698695729437105
                      ],
                ]
        });

        map.addLayer({
          'id': 'gifLayer2',
          'type': 'raster',
          // Use "iso" as the data source for this layer
          'source': 'iidabashi',
          'paint': { 'raster-opacity': 0.85 }
        },'transit-label');           
      
      map.addSource('ochanomizu', {
                'type': 'image',
                'url': 'https://tichimura.github.io/station-maps-demo/resource/ochanomizu.png',
                // 'url': 'https://user-images.githubusercontent.com/1793451/112251108-fa2ded00-8c9d-11eb-9fe5-39e5660d51e3.png',          
                "coordinates": [
			[
		          139.76541203920243,
		          35.69910519525931
			],
			[
			  139.76317537312548,
			  35.6997373644797
			],
			[
			  139.76353117334162,
			  35.70059276352033
			],
			[
      139.76579980785834,
      35.69995530129867
			]
                ]
        });

        map.addLayer({
          'id': 'gifLayer3',
          'type': 'raster',
          // Use "iso" as the data source for this layer
          'source': 'ochanomizu',
          'paint': { 'raster-opacity': 0.85 }
        },'transit-label');   
	    
	    
       map.addSource('shinbashi', {
                'type': 'image',
                'url': 'https://tichimura.github.io/station-maps-demo/resource/shinbashi.png',
                // 'url': 'https://user-images.githubusercontent.com/1793451/112255909-7a585080-8ca6-11eb-9b10-36f7a81bce31.png',          
                "coordinates": [
 
        [
          139.75845553464086,
          35.667477386837064
        ],
        [
          139.7588226666458,
          35.665502895185654
        ],
        [
          139.7578783390399,
          35.66538251308576
        ],
       [
          139.75759058763458,
          35.66737572526415
        ],                  
                  ]
        });

        map.addLayer({
          'id': 'gifLayer4',
          'type': 'raster',
          // Use "iso" as the data source for this layer
          'source': 'shinbashi',
          'paint': { 'raster-opacity': 0.5 }
        },'transit-label');	    
      

        map.on('click', 'work-data', function(e){

          var popup = new mapboxgl.Popup()
              .setLngLat(e.lngLat)
              .setHTML(`<h3>` + e.features[0].properties.cnt + `</h3>`+`<h4 style="text-align: center">` + e.features[0].properties.nam + `</h4>`+`<h4 style="text-align: center">` + e.features[0].properties.pps + `</h4>`+`<h4 style="text-align: center">` + e.features[0].properties.srg + `</h4>`+`<h4 style="text-align: center">` + e.features[0].properties.rdn + `</h4>`)
              .addTo(map);
        })

        var videos = {'RQA5RcIZlAM':[139.69936089963744, 35.69350996590232],'lkIJYc4UH60':[139.70030208085188,35.6595574453778],'ZbekZoIwPl4':[139.73070222009164,35.689708324156825]}; 
        var videoid;
        var i = 0;
        for ( videoid in videos){
              
              var phtml = 'var tag = document.createElement(\'script\');\n'
              phtml += 'tag.src = "https://www.youtube.com/iframe_api";\n';
              phtml += 'var firstScriptTag = document.getElementsByTagName(\'script\')[0];\n';
              phtml += 'if(!firstScriptTag.id.includes(\'www-widgetapi-script\')){;\n'
              phtml += '  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);\n';
              phtml += '};\n';
              phtml += 'var player;\n';
              phtml += 'function onYouTubeIframeAPIReady() {\n';
              phtml += '  player = new YT.Player(\'player_'+ i +'\', {\n';
              phtml += '    videoId: \'' + videoid + '\',\n';
              phtml += '    events: {\n';
              phtml += '      \'onReady\': onPlayerReady,\n';
              phtml += '      \'onStateChange\': onPlayerStateChange\n';
              phtml += '    }\n';
              phtml += '  });\n';
              phtml += '}\n';
              phtml += 'function onPlayerReady(event) {\n';
              phtml += '  event.target.playVideo();\n';
              phtml += '}\n';
              phtml += 'var done = false;\n';
              phtml += 'function onPlayerStateChange(event) {\n';
              phtml += 'if (event.data == YT.PlayerState.PLAYING && !done) {\n';
              phtml += '    setTimeout(stopVideo, 6000);\n';
              phtml += '    done = true;\n';
              phtml += '  }\n';
              phtml += '}\n';
              phtml += 'function stopVideo() {\n';
              phtml += '  player.stopVideo();\n';
              phtml += '}\n';

              // this is only for single box
              // var div = window.document.createElement('div');
              // div.id = 'player_'+i;              

              var iframe = window.document.createElement('iframe');
              var script = window.document.createElement('script');

              iframe.id = 'player_'+i;
              iframe.frameBorder = "0";
              iframe.allowFullscreen = "1";
              iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
              iframe.title="YouTube video player";
              iframe.width="250";
              iframe.height="250";
              iframe.src="https://www.youtube.com/embed/" + videoid +"?enablejsapi=1&amp;widgetid=1";
              script.innerHTML = phtml;
              iframe.appendChild(script);

              var latlng = videos[videoid];
              var marker = new mapboxgl.Marker({color: "#ba8c8c"})
              .setLngLat(videos[videoid])
              .setPopup(new mapboxgl.Popup().setDOMContent(iframe)) // add popup
              .addTo(map);

              i++;

        }

        // 1. addEventListner and filter event
        // 2. create a layer for the popups

    });

    map.on('click', 'jr-demo3', function(e){
      map.flyTo({
        center: e.features[0].geometry.coordinates,
        bearing: e.features[0].properties.bearing,
        zoom: 18
      });
    })


    function buildLocationList(data) {
	      
        var station_features = map.queryRenderedFeatures({ layers: ['jr-demo2'] });	

        station_features.forEach(function (store, i) {
                /**
                 * Create a shortcut for `store.properties`,
                 * which will be used several times below.
                 **/
                var prop = store.properties;
      
                /* Add a new listing section to the sidebar. */
                var listings = document.getElementById('listings');
                var listing = listings.appendChild(document.createElement('div'));
                /* Assign a unique `id` to the listing. */
                listing.id = 'listing-' + prop.pnum;
                /* Assign the `item` class to each listing for styling. */
                listing.className = 'item';
      
                /* Add the link to the individual listing created above. */
                var link = listing.appendChild(document.createElement('a'));
                link.href = '#';
                link.className = 'title';
                link.id = 'link-' + prop.id;
                link.innerHTML = prop.address;
      
                /* Add details to the individual listing. */
                var details = listing.appendChild(document.createElement('div'));
                details.innerHTML = prop.city;
                if (prop.phone) {
                  details.innerHTML += ' &middot; ' + prop.phoneFormatted;
                }
      
                /**
                 * Listen to the element and when it is clicked, do four things:
                 * 1. Update the `currentFeature` to the store associated with the clicked link
                 * 2. Fly to the point
                 * 3. Close all other popups and display popup for clicked store
                 * 4. Highlight listing in sidebar (and remove highlight for all other listings)
                 **/
                link.addEventListener('click', function (e) {
                  for (var i = 0; i < station_features.length; i++) {
                    if (this.id === 'link-' + station_features[i].properties.pnum) {
                      var clickedListing = station_featuress[i];
          map.flyTo({
            center: clickedListing.geometry.coordinates,
            
            zoom: 15
          });
                    }
                  }
                  var activeItem = document.getElementsByClassName('active');
                  if (activeItem[0]) {
                    activeItem[0].classList.remove('active');
                  }
                  this.parentNode.classList.add('active');
                });
              });

            }


</script>

</body>
</html>
    
     
